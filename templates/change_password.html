{% extends "base.html" %}

{% load static %}

{% block title %}Change Password{% endblock title %}

{% block content %}
<div class="container mt-5 pt-5">
    <div class="row">
        <div class="col-md-3 border-end">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'account_page' %}">Thông tin tài khoản</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active text-danger fw-bold" aria-current="page">Thay đổi mật khẩu</a>
                </li>
            </ul>
        </div>
        <div class="col-md-9">
            <h4 class="mb-3 fw-bold">Thay đổi mật khẩu</h4>
            <form id="change-password-form">
                <div class="mb-3">
                    <label class="form-label">Mật khẩu hiện tại</label>
                    <input type="password" id="old-password" class="form-control" placeholder="Nhập mật khẩu hiện tại" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Mật khẩu mới</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Nhập mật khẩu mới" required>
                </div>
                <div class="mb-4">
                    <label class="form-label">Xác nhận mật khẩu mới</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="Nhập lại mật khẩu mới" required>
                </div>
                <button class="btn btn-primary w-100 rounded-pill fw-semibold" type="submit">Lưu thay đổi</button>
            </form>
      </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('access');
        if (!token) {
            alert('Bạn cần đăng nhập để đổi mật khẩu!');
            window.location.href = '/login/';
        }
    });

    document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const old_password = document.getElementById('old-password').value;
        const new_password = document.getElementById('new-password').value;
        const confirm_password = document.getElementById('confirm-password').value;

        const token = localStorage.getItem('access');

        const response = await fetch('/api/user/change-password/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ old_password, new_password, confirm_password})
        });

        const data = await response.json();

        if (response.ok) {
            alert("Đổi mật khẩu thành công!");
            window.location.href = '/';
        } else {
            if (data.old_password) {
                alert(data.old_password[0]);
            } else if (data.confirm_password) {
                alert(data.confirm_password[0]);
            } else {
                const firstKey = Object.keys(data)[0];
                alert(data[firstKey][0]);
            }
        }
    });
</script>
{% endblock content %}